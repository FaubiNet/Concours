<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Hackers Academy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
</head>
   <style>
        .json-view {
            background: #1a1a1a;
            padding: 1rem;
            border-radius: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
        }
        .particle {
            animation: particleFlow 3s linear forwards;
        }
        @keyframes particleFlow {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
    </style>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    
    <!-- Login Admin -->
    <div id="adminLogin" class="container mx-auto px-4 py-20 max-w-md">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-bold mb-6 text-center text-cyan-400">üîë Connexion Admin</h2>
            <div id="adminError" class="text-red-400 text-sm mb-4 hidden"></div>
            <input id="adminPassword" type="password" 
                   class="w-full bg-gray-700 rounded-lg p-3 mb-4 focus:ring-2 focus:ring-cyan-500 outline-none"
                   placeholder="Mot de passe ma√Ætre">
            <button onclick="adminLogin()"
                    class="w-full bg-cyan-600 hover:bg-cyan-700 py-3 rounded-lg font-bold transition-colors">
                Acc√©der au Dashboard
            </button>
        </div>
    </div>

    <!-- Dashboard Admin -->
    <div id="adminDashboard" class="hidden container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">üõ†Ô∏è Dashboard Admin</h1>
            <button onclick="logoutAdmin()"
                    class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg">
                D√©connexion
            </button>
        </div>

        <!-- Navigation -->
        <div class="grid grid-cols-2 gap-4 mb-8">
            <button data-section="winners" 
                    class="admin-nav-btn bg-gray-800 hover:bg-gray-700 p-4 rounded-lg font-bold transition-colors">
                üèÜ Gestion des Gagnants
            </button>
            <button data-section="downloads" 
                    class="admin-nav-btn bg-gray-800 hover:bg-gray-700 p-4 rounded-lg font-bold transition-colors">
                üì¶ Gestion des T√©l√©chargements
            </button>
        </div>

        <!-- Section Gestion des Gagnants -->
        <div id="winnersSection" class="admin-section">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Liste des Gagnants</h2>
                <button onclick="showWinnerModal()"
                        class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg">
                    ‚ûï Ajouter un Gagnant
                </button>
            </div>
            
            <div id="winnersList" class="space-y-4">
                <!-- Dynamic content -->
            </div>
        </div>

        <!-- Section Gestion des T√©l√©chargements -->
        <div id="downloadsSection" class="admin-section hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold mb-4">Configuration des Liens</h2>
                <div class="json-view">
                    <pre id="downloadConfig"></pre>
                </div>
                <button onclick="updateDownloadConfig()"
                        class="mt-4 bg-cyan-600 hover:bg-cyan-700 px-4 py-2 rounded-lg">
                    üíæ Enregistrer les modifications
                </button>
            </div>
        </div>

        <!-- Modale Gestion Gagnant -->
        <div id="winnerModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center">
            <div class="bg-gray-800 p-6 rounded-xl w-full max-w-md mx-4">
                <h3 class="text-xl font-bold mb-4" id="modalTitle">Nouveau Gagnant</h3>
                
                <div class="space-y-4">
                    <input id="winnerPosition" type="number" min="1" 
                           class="w-full bg-gray-700 p-3 rounded-lg"
                           placeholder="Position">
                    <input id="winnerName" 
                           class="w-full bg-gray-700 p-3 rounded-lg"
                           placeholder="Nom du gagnant">
                    <input id="winnerPoints" 
                           class="w-full bg-gray-700 p-3 rounded-lg"
                           placeholder="Points (ex: 24K points)">
                    <input id="winnerColor" 
                           class="w-full bg-gray-700 p-3 rounded-lg"
                           placeholder="Couleur (ex: from-cyan-500 to-purple-500)">
                    <input id="winnerMedal" 
                           class="w-full bg-gray-700 p-3 rounded-lg"
                           placeholder="M√©daille (ex: ü•á)">
                    <input id="winnerSound" 
                           class="w-full bg-gray-700 p-3 rounded-lg"
                           placeholder="URL du son">
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="saveWinner()" 
                            class="flex-1 bg-cyan-600 hover:bg-cyan-700 py-2 rounded-lg">
                        Enregistrer
                    </button>
                    <button onclick="closeWinnerModal()" 
                            class="flex-1 bg-gray-600 hover:bg-gray-700 py-2 rounded-lg">
                        Annuler
                    </button>
                </div>
            </div>
        </div>

        <div id="winnerModal" class="...">
 <textarea id="rewardDescription" 
              class="w-full bg-gray-700 p-3 rounded-lg"
              placeholder="Description de la r√©compense"></textarea>
                  <div class="mt-4">
        <h4 class="font-bold mb-2">R√©compenses</h4>
        <div id="rewardFields" class="space-y-2">
            <!-- Les champs de r√©compense seront g√©n√©r√©s ici -->
        </div>
        <button onclick="addRewardField()" class="mt-2 text-cyan-400 text-sm">
            + Ajouter une r√©compense
        </button>
    </div>
</div>
    </div>

    <script>
            const ADMIN_TOKEN = "Bearer BlessHack"; // Doit correspondre √† Netlify.toml

        let currentEditableWinner = null;

        // Gestion Authentification
      async function adminLogin() {
    const password = document.getElementById('adminPassword').value;
    const errorDiv = document.getElementById('adminError');
    
    try {
        const response = await fetch('/.netlify/functions/verify-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': ADMIN_TOKEN
            },
            body: JSON.stringify({ 
                admin: true,
                password: password 
            })
        });

        const data = await response.json();

        if (!response.ok) throw new Error(data.error || 'Erreur serveur');

        if(data.valid) {
            localStorage.setItem('adminAuth', 'true');
            document.getElementById('adminLogin').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            loadAdminData();
        } else {
            errorDiv.textContent = "Acc√®s refus√© !";
            errorDiv.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error:', error);
        errorDiv.textContent = "Erreur de connexion";
        errorDiv.classList.remove('hidden');
    }
}

        function logoutAdmin() {
            localStorage.removeItem('adminAuth');
            location.reload();
        }

        // Chargement des donn√©es
        async function loadAdminData() {
            try {
                const [winnersRes, downloadsRes] = await Promise.all([
                    fetch('/.netlify/functions/verify-password', {
                        headers: { 'Authorization': ADMIN_TOKEN }
                    }),
                    fetch('/.netlify/functions/get-download', {
                        headers: { 'Authorization': ADMIN_TOKEN }
                    })
                ]);

                const winnersData = await winnersRes.json();
                const downloadsData = await downloadsRes.json();

                renderWinners(winnersData);
                renderDownloads(downloadsData);
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

function renderWinners(winners) {
    const container = document.getElementById('winnersList');
    container.innerHTML = Object.values(winners)
        .sort((a, b) => a.position - b.position)
        .map(winner => `
            <div class="bg-gray-800 p-4 rounded-lg">
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <span class="font-bold">${winner.position}.</span>
                        ${winner.name} - ${winner.points}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editWinner(${winner.position})" class="bg-blue-600 px-3 py-1 rounded">‚úèÔ∏è</button>
                        <button onclick="deleteWinner(${winner.position})" class="bg-red-600 px-3 py-1 rounded">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="mt-2">
                     ${winner.rewards.map(reward => `
        <div class="ml-4 p-2 bg-gray-700 rounded mb-2">
            <div class="flex justify-between">
                <div>
                    ${reward.icon} ${reward.title}
                    <div class="text-xs text-gray-300">${reward.description}</div>
                </div>
                <div>
                    <button onclick="editReward(${winner.position}, '${reward.downloadKey}')" 
                            class="text-blue-400 hover:text-blue-300 text-xs mr-2">
                        ‚úèÔ∏è
                    </button>
                    <button onclick="deleteReward(${winner.position}, '${reward.downloadKey}')" 
                            class="text-red-400 hover:text-red-300 text-xs">
                        √ó
                    </button>
                </div>
            </div>
            <div class="text-xs text-cyan-400 mt-1">Cl√©: ${reward.downloadKey}</div>
        </div>
    // Apr√®s (correction)
`).join('')}
            </div>` // FERMETURE MANQUANTE
        ).join('');
}
async function addRewardPrompt(position) {
    const title = prompt('Titre de la r√©compense :');
    const downloadKey = prompt('Cl√© de t√©l√©chargement :');
    
    if(title && downloadKey) {
        const newReward = {
            title,
            downloadKey,
            icon: "‚≠ê",
            description: "Nouvelle r√©compense"
        };

        const response = await fetch('/.netlify/functions/verify-password', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': ADMIN_TOKEN
            },
            body: JSON.stringify({
                position,
                rewards: [...winners[position].rewards, newReward]
            })
        });
        
        loadAdminData();
    }
}

async function deleteReward(position, downloadKey) {
    if(confirm(`Supprimer la r√©compense ${downloadKey} ?`)) {
        const updatedRewards = winners[position].rewards.filter(r => r.downloadKey !== downloadKey);
        
        const response = await fetch('/.netlify/functions/verify-password', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': ADMIN_TOKEN
            },
            body: JSON.stringify({
                position,
                rewards: updatedRewards
            })
        });
        
        loadAdminData();
    }
}

        function renderDownloads(config) {
            const pre = document.getElementById('downloadConfig');
            pre.textContent = JSON.stringify(config, null, 2);
        }

        function addRewardField(reward = {}) {
    const field = document.createElement('div');
    field.className = 'flex gap-2';
    field.innerHTML = `
        <input value="${reward.title || ''}" placeholder="Titre" class="flex-1 bg-gray-700 p-2 rounded">
        <input value="${reward.icon || ''}" placeholder="Emoji" class="w-16 bg-gray-700 p-2 rounded">
        <input value="${reward.downloadKey || ''}" placeholder="Cl√©" class="w-24 bg-gray-700 p-2 rounded">
        <button onclick="this.parentElement.remove()" class="text-red-400">√ó</button>
    `;
    document.getElementById('rewardFields').appendChild(field);
}

function loadRewards(rewards) {
    document.getElementById('rewardFields').innerHTML = '';
    rewards?.forEach(reward => addRewardField(reward));
}

        // Gestion des gagnants
        function showWinnerModal(winner = null) {
            currentEditableWinner = winner;
            const modal = document.getElementById('winnerModal');
            
            if(winner) {
                document.getElementById('modalTitle').textContent = "Modifier Gagnant";
                document.getElementById('winnerPosition').value = winner.position;
                document.getElementById('winnerName').value = winner.name;
                document.getElementById('winnerPoints').value = winner.points;
                document.getElementById('winnerColor').value = winner.color;
                document.getElementById('winnerMedal').value = winner.medal;
                document.getElementById('winnerSound').value = winner.sound;
                        loadRewards(winner.rewards);

            } else {
                        document.getElementById('rewardFields').innerHTML = '';
                document.getElementById('modalTitle').textContent = "Nouveau Gagnant";
                ['position', 'name', 'points', 'color', 'medal', 'sound'].forEach(id => {
                    document.getElementById(`winner${id.charAt(0).toUpperCase() + id.slice(1)}`).value = '';
                });
            }
            
            modal.classList.remove('hidden');
        }

async function saveWinner() {
    const rewards = Array.from(document.querySelectorAll('#rewardFields div')).map(field => {
        const inputs = field.querySelectorAll('input');
        return {
            title: inputs[0].value,
            icon: inputs[1].value,
            downloadKey: inputs[2].value,
            description: document.querySelector('#rewardDescription').value || "Description par d√©faut"
        };
    });

    async function editReward(position, downloadKey) {
    const reward = winners[position].rewards.find(r => r.downloadKey === downloadKey);
    
    const newTitle = prompt('Nouveau titre:', reward.title);
    const newKey = prompt('Nouvelle cl√©:', reward.downloadKey);
    
    if(newTitle && newKey) {
        const updatedRewards = winners[position].rewards.map(r => 
            r.downloadKey === downloadKey ? 
            { ...r, title: newTitle, downloadKey: newKey } : r
        );
        
        const response = await fetch('/.netlify/functions/verify-password', {
            method: 'PUT',
            headers: { 'Authorization': ADMIN_TOKEN },
            body: JSON.stringify({ position, rewards: updatedRewards })
        });
        
        loadAdminData();
    }
}

    const winnerData = {
        position: document.getElementById('winnerPosition').value,
        name: document.getElementById('winnerName').value,
        points: document.getElementById('winnerPoints').value,
        color: document.getElementById('winnerColor').value,
        medal: document.getElementById('winnerMedal').value,
        sound: document.getElementById('winnerSound').value,
        rewards: rewards
    };
            try {
                const response = await fetch('/.netlify/functions/verify-password', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': ADMIN_TOKEN
                    },
                    body: JSON.stringify(winnerData)
                });

                if(response.ok) {
                    loadAdminData();
                    closeWinnerModal();
                }
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        async function deleteWinner(position) {
            if(confirm(`Supprimer le gagnant ${position} ?`)) {
                try {
                    await fetch('/.netlify/functions/verify-password', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': ADMIN_TOKEN
                        },
                        body: JSON.stringify({ position })
                    });
                    loadAdminData();
                } catch (error) {
                    console.error('Erreur:', error);
                }
            }
        }

        // Gestion des t√©l√©chargements
        async function updateDownloadConfig() {
            try {
                const newConfig = JSON.parse(document.getElementById('downloadConfig').textContent);
                
                await fetch('/.netlify/functions/get-download', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': ADMIN_TOKEN
                    },
                    body: JSON.stringify(newConfig)
                });

                alert('Configuration sauvegard√©e !');
            } catch (error) {
                alert('Erreur de format JSON !');
            }
        }

        // Navigation
        document.querySelectorAll('.admin-nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.admin-section').forEach(section => {
                    section.classList.add('hidden');
                });
                document.getElementById(`${btn.dataset.section}Section`).classList.remove('hidden');
            });
        });

        // Initialisation
        if(localStorage.getItem('adminAuth')) {
            document.getElementById('adminLogin').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            loadAdminData();
        }
    </script>
</body>
</html>